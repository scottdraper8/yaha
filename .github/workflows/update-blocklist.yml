name: Update Blocklist

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'blocklists.json'
      - 'compile_blocklist.py'
      - '.github/workflows/update-blocklist.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run blocklist compiler
        id: compile
        run: |
          python compile_blocklist.py
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT

          # Exit code 0 = no changes, 1 = updated, 2+ = error
          if [ $EXIT_CODE -eq 0 ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ“ No domain changes detected"
          elif [ $EXIT_CODE -eq 1 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Domain content changed"
          else
            echo "âœ— Compilation failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: Update or create latest release
        if: steps.compile.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Count domains
          GENERAL_COUNT=$(grep -v '^#' blocklists/hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
          NSFW_COUNT=$(grep -v '^#' blocklists/hosts_nsfw | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
          TIMESTAMP=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

          # Create release notes
          cat > release_notes.md << EOF
          # YAHA Blocklist - Latest

          **Automatically updated every 6 hours**

          ## ðŸ“Š Statistics

          - **General Protection:** ${GENERAL_COUNT} domains
          - **Complete (with NSFW):** ${NSFW_COUNT} domains
          - **Last Updated:** ${TIMESTAMP}

          ## ðŸ“¥ Usage

          ### General Protection (Ads, Trackers, Malware)
          \`\`\`
          https://github.com/scottdraper8/yaha/releases/download/latest/hosts
          \`\`\`

          ### Complete Protection (Including NSFW)
          \`\`\`
          https://github.com/scottdraper8/yaha/releases/download/latest/hosts_nsfw
          \`\`\`

          Copy either URL into any application that supports hosts-based blocking (TrackerControl, Pi-hole, AdGuard, etc).

          ## ðŸ“‹ Source Lists

          - 24 General protection lists
          - 3 NSFW blocking lists

          See [README](https://github.com/scottdraper8/yaha#readme) for detailed statistics and source list breakdown.
          EOF

          # Delete existing 'latest' release and tag if it exists
          gh release delete latest --yes 2>/dev/null || true
          git push --delete origin latest 2>/dev/null || true

          # Create new 'latest' release with updated files
          gh release create latest \
            --title "YAHA Blocklist - Latest" \
            --notes-file release_notes.md \
            blocklists/hosts \
            blocklists/hosts_nsfw

          echo "âœ“ Release 'latest' updated with ${GENERAL_COUNT} general / ${NSFW_COUNT} complete domains"

      - name: Commit README to main
        if: steps.compile.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Count domains for commit message
          GENERAL_COUNT=$(grep -v '^#' blocklists/hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
          NSFW_COUNT=$(grep -v '^#' blocklists/hosts_nsfw | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')

          # Commit README and domain count tracker
          git add README.md
          git commit -m "Update blocklist stats: ${GENERAL_COUNT} general / ${NSFW_COUNT} with NSFW [automated]"
          git push

      - name: No changes detected
        if: steps.compile.outputs.changed == 'false'
        run: |
          echo "âœ“ Blocklists are up to date - no release update needed"
