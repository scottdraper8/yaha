name: Annual History Cleanup

on:
  schedule:
    # Run on January 1st at 00:00 UTC every year
    - cron: '0 0 1 1 *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  squash-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Squash automated commits from previous year
        run: |
          # Current year is determined
          CURRENT_YEAR=$(date +%Y)
          PREVIOUS_YEAR=$((CURRENT_YEAR - 1))
          ORIGINAL_HEAD=$(git rev-parse HEAD)

          echo "Squashing automated commits from ${PREVIOUS_YEAR}..."

          # First and last commits of previous year are located
          FIRST_COMMIT=$(git log --reverse --since="${PREVIOUS_YEAR}-01-01" --until="${PREVIOUS_YEAR}-12-31 23:59:59" --format="%H" | head -1)
          LAST_COMMIT=$(git log --until="${PREVIOUS_YEAR}-12-31 23:59:59" --format="%H" -n 1)

          if [ -z "$FIRST_COMMIT" ]; then
            echo "No commits found in ${PREVIOUS_YEAR}, nothing to squash"
            exit 0
          fi

          # Automated commits to squash are counted
          TOTAL_AUTOMATED_COUNT=$(git log --since="${PREVIOUS_YEAR}-01-01" --until="${PREVIOUS_YEAR}-12-31 23:59:59" --grep="\[automated\]" --oneline | wc -l | tr -d ' ')

          if [ "$TOTAL_AUTOMATED_COUNT" -eq 0 ]; then
            echo "No automated commits to squash"
            exit 0
          fi

          echo "Found ${TOTAL_AUTOMATED_COUNT} automated commits to squash"

          # Commit before first commit of previous year is resolved
          BASE_COMMIT=$(git rev-parse --verify "${FIRST_COMMIT}^" 2>/dev/null || true)

          # Temporary branch is created
          if [ -z "$BASE_COMMIT" ]; then
            echo "Previous year starts at root commit; history rebuilt from empty root."
            git checkout --orphan temp-squash
            git rm -rf . >/dev/null 2>&1 || true
            git clean -fdx
            PREV_RANGE="${LAST_COMMIT}"
          else
            git checkout -b temp-squash "${BASE_COMMIT}"
            PREV_RANGE="${BASE_COMMIT}..${LAST_COMMIT}"
          fi

          PREV_COMMITS=$(git rev-list --reverse ${PREV_RANGE})
          STAGED_AUTOMATED=0
          BATCH_COUNT=0

          # Cherry-pick behavior is normalized for merge commits.
          attempt_pick() {
            local commit="$1"
            shift
            if ! git cherry-pick "$@" "$commit"; then
              if [ -f .git/CHERRY_PICK_HEAD ] && git diff --quiet; then
                git cherry-pick --skip
              else
                exit 1
              fi
            fi
          }

          pick_commit() {
            local commit="$1"
            local mode="$2"
            local parent_count
            parent_count=$(git show -s --format=%P "$commit" | wc -w | tr -d ' ')
            if [ "$parent_count" -gt 1 ]; then
              if [ "$mode" = "no-commit" ]; then
                attempt_pick "$commit" -m 1 --no-commit
              else
                attempt_pick "$commit" -m 1
              fi
            else
              if [ "$mode" = "no-commit" ]; then
                attempt_pick "$commit" --no-commit
              else
                attempt_pick "$commit"
              fi
            fi
          }

          for COMMIT in $PREV_COMMITS; do
            if git log -1 --format=%B "$COMMIT" | grep -q "\[automated\]"; then
              pick_commit "$COMMIT" "no-commit"
              STAGED_AUTOMATED=1
              BATCH_COUNT=$((BATCH_COUNT + 1))
            else
              if [ "$STAGED_AUTOMATED" -eq 1 ]; then
                DOMAIN_COUNT=$(grep -v '^#' hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
                git commit -m "Archive: Blocklist updates for ${PREVIOUS_YEAR}" \
                           -m "Squashed ${BATCH_COUNT} automated commits from ${PREVIOUS_YEAR}." \
                           -m "Final state: ${DOMAIN_COUNT} domains blocked." \
                           -m "This automated cleanup runs annually to keep repository history manageable."
                STAGED_AUTOMATED=0
                BATCH_COUNT=0
              fi
              pick_commit "$COMMIT"
            fi
          done

          if [ "$STAGED_AUTOMATED" -eq 1 ]; then
            DOMAIN_COUNT=$(grep -v '^#' hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')
            git commit -m "Archive: Blocklist updates for ${PREVIOUS_YEAR}" \
                       -m "Squashed ${BATCH_COUNT} automated commits from ${PREVIOUS_YEAR}." \
                       -m "Final state: ${DOMAIN_COUNT} domains blocked." \
                       -m "This automated cleanup runs annually to keep repository history manageable."
          fi

          # Commits after previous year are replayed
          POST_COMMITS=$(git rev-list --reverse "${LAST_COMMIT}..${ORIGINAL_HEAD}")
          for COMMIT in $POST_COMMITS; do
            pick_commit "$COMMIT"
          done

          # Force push to main
          git push origin temp-squash:main --force

          echo "âœ“ Successfully squashed ${TOTAL_AUTOMATED_COUNT} commits from ${PREVIOUS_YEAR}"

      - name: Cleanup
        if: always()
        run: |
          git checkout main
          git branch -D temp-squash 2>/dev/null || true
