name: Annual History Cleanup

on:
  schedule:
    # Run on January 1st at 00:00 UTC every year
    - cron: '0 0 1 1 *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  squash-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Squash github-actions[bot] commits from previous year
        run: |
          CURRENT_YEAR=$(date +%Y)
          PREVIOUS_YEAR=$((CURRENT_YEAR - 1))
          YEAR_START="${PREVIOUS_YEAR}-01-01"
          YEAR_END="${PREVIOUS_YEAR}-12-31 23:59:59"
          ORIGINAL_HEAD=$(git rev-parse HEAD)
          BOT_AUTHOR_LABEL="github-actions[bot]"
          BOT_AUTHOR_REGEX="github-actions\\[bot\\]"

          echo "Squashing ${BOT_AUTHOR_LABEL} commits from ${PREVIOUS_YEAR}..."

          FIRST_COMMIT=$(git log --reverse --since="${YEAR_START}" --until="${YEAR_END}" --format="%H" | head -1)
          LAST_COMMIT=$(git log --until="${YEAR_END}" --format="%H" -n 1)

          if [ -z "$FIRST_COMMIT" ]; then
            echo "No commits found in ${PREVIOUS_YEAR}, nothing to squash"
            exit 0
          fi

          TOTAL_BOT_COUNT=$(git log --since="${YEAR_START}" --until="${YEAR_END}" --author="${BOT_AUTHOR_REGEX}" --oneline | wc -l | tr -d ' ')

          if [ "$TOTAL_BOT_COUNT" -eq 0 ]; then
            echo "No ${BOT_AUTHOR_LABEL} commits to squash"
            exit 0
          fi

          echo "Found ${TOTAL_BOT_COUNT} ${BOT_AUTHOR_LABEL} commits to squash"

          BASE_COMMIT=$(git rev-parse --verify "${FIRST_COMMIT}^" 2>/dev/null || true)

          if [ -z "$BASE_COMMIT" ]; then
            echo "Previous year starts at root commit; history rebuilt from empty root."
            git checkout --orphan temp-squash
            git rm -rf . >/dev/null 2>&1 || true
            git clean -fdx
            PREV_RANGE="${LAST_COMMIT}"
          else
            git checkout -b temp-squash "${BASE_COMMIT}"
            PREV_RANGE="${BASE_COMMIT}..${LAST_COMMIT}"
          fi

          PREV_COMMITS=$(git rev-list --reverse ${PREV_RANGE})
          STAGED_BOT=0
          BATCH_COUNT=0

          attempt_pick() {
            local commit="$1"
            shift
            if ! git cherry-pick "$@" "$commit"; then
              if [ -f .git/CHERRY_PICK_HEAD ] && git diff --quiet; then
                git cherry-pick --skip
              else
                git cherry-pick --abort
                exit 1
              fi
            fi
          }

          pick_commit() {
            local commit="$1"
            local mode="$2"
            local parent_count
            parent_count=$(git show -s --format=%P "$commit" | wc -w | tr -d ' ')
            if [ "$parent_count" -gt 1 ]; then
              if [ "$mode" = "no-commit" ]; then
                attempt_pick "$commit" -m 1 --no-commit
              else
                attempt_pick "$commit" -m 1
              fi
            else
              if [ "$mode" = "no-commit" ]; then
                attempt_pick "$commit" --no-commit
              else
                attempt_pick "$commit"
              fi
            fi
          }

          get_domain_count() {
            if [ -f hosts ]; then
              grep -v '^#' hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' '
            else
              echo "unknown"
            fi
          }

          commit_squash_batch() {
            local domain_count
            if git diff --cached --quiet; then
              STAGED_BOT=0
              BATCH_COUNT=0
              return
            fi
            domain_count=$(get_domain_count)
            git commit -m "Archive: Blocklist updates for ${PREVIOUS_YEAR}" \
                       -m "Squashed ${BATCH_COUNT} ${BOT_AUTHOR_LABEL} commits from ${PREVIOUS_YEAR}." \
                       -m "Final state: ${domain_count} domains blocked." \
                       -m "This automated cleanup runs annually to keep repository history manageable."
            STAGED_BOT=0
            BATCH_COUNT=0
          }

          for COMMIT in $PREV_COMMITS; do
            AUTHOR_INFO=$(git show -s --format='%an <%ae>' "$COMMIT")
            if printf '%s' "$AUTHOR_INFO" | grep -Eq "$BOT_AUTHOR_REGEX"; then
              pick_commit "$COMMIT" "no-commit"
              STAGED_BOT=1
              BATCH_COUNT=$((BATCH_COUNT + 1))
            else
              if [ "$STAGED_BOT" -eq 1 ]; then
                commit_squash_batch
              fi
              pick_commit "$COMMIT"
            fi
          done

          if [ "$STAGED_BOT" -eq 1 ]; then
            commit_squash_batch
          fi

          POST_COMMITS=$(git rev-list --reverse "${LAST_COMMIT}..${ORIGINAL_HEAD}")
          for COMMIT in $POST_COMMITS; do
            pick_commit "$COMMIT"
          done

          git push origin temp-squash:main --force

          echo "âœ“ Successfully squashed ${TOTAL_BOT_COUNT} ${BOT_AUTHOR_LABEL} commits from ${PREVIOUS_YEAR}"

      - name: Cleanup
        if: always()
        run: |
          git checkout main
          git branch -D temp-squash 2>/dev/null || true
