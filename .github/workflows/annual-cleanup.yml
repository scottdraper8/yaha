name: Annual History Cleanup

on:
  schedule:
    # Run on January 1st at 00:00 UTC every year
    - cron: '0 0 1 1 *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  squash-history:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Squash automated commits from previous year
        run: |
          # Get current year
          CURRENT_YEAR=$(date +%Y)
          PREVIOUS_YEAR=$((CURRENT_YEAR - 1))

          echo "Squashing automated commits from ${PREVIOUS_YEAR}..."

          # Find the first commit of the previous year
          FIRST_COMMIT=$(git log --reverse --since="${PREVIOUS_YEAR}-01-01" --until="${PREVIOUS_YEAR}-12-31 23:59:59" --format="%H" | head -1)

          if [ -z "$FIRST_COMMIT" ]; then
            echo "No commits found in ${PREVIOUS_YEAR}, nothing to squash"
            exit 0
          fi

          # Get the commit before the first commit of previous year
          PARENT_COMMIT=$(git rev-parse --verify "${FIRST_COMMIT}^" 2>/dev/null || true)

          if [ -z "$PARENT_COMMIT" ]; then
            echo "Previous year starts at root commit; squashing from repository root."
            RESET_MODE="orphan"
            LOG_RANGE="--root"
          else
            RESET_MODE="soft"
            RESET_TARGET="${PARENT_COMMIT}"
            LOG_RANGE="${PARENT_COMMIT}..HEAD"
          fi

          # Count automated commits to squash
          AUTOMATED_COUNT=$(git log ${LOG_RANGE} --grep="\[automated\]" --oneline | wc -l | tr -d ' ')

          if [ "$AUTOMATED_COUNT" -eq 0 ]; then
            echo "No automated commits to squash"
            exit 0
          fi

          echo "Found ${AUTOMATED_COUNT} automated commits to squash"

          # Create a temporary branch
          if [ "$RESET_MODE" = "orphan" ]; then
            git checkout --orphan temp-squash
            git add -A
          else
            git checkout -b temp-squash

            # Soft reset to parent commit (keeps all changes staged)
            git reset --soft ${RESET_TARGET}
          fi

          # Get final state stats
          DOMAIN_COUNT=$(grep -v '^#' hosts | grep -v '^[[:space:]]*$' | wc -l | tr -d ' ')

          # Commit squashed changes
          git commit -m "Archive: Blocklist updates for ${PREVIOUS_YEAR}" \
                     -m "Squashed ${AUTOMATED_COUNT} automated commits from ${PREVIOUS_YEAR}." \
                     -m "Final state: ${DOMAIN_COUNT} domains blocked." \
                     -m "This automated cleanup runs annually to keep repository history manageable."

          # Force push to main
          git push origin temp-squash:main --force

          echo "âœ“ Successfully squashed ${AUTOMATED_COUNT} commits from ${PREVIOUS_YEAR}"

      - name: Cleanup
        if: always()
        run: |
          git checkout main
          git branch -D temp-squash 2>/dev/null || true
